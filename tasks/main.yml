---
- name: Install FreeIPA server
  package:
    name:
      - freeipa-server
    state: present

- name: Install a daily cron job to disable inactive users
  template:
    src: disable_inactive_users.j2.sh
    dest: /etc/cron.daily/disable_inactive_users.sh
    mode: 0500

- name: Copy DHS CA certs
  get_url:
    dest: /usr/local/share
    url: https://pki.treas.gov/dhsca_fullpath.p7b
- name: Convert P7B to PEM
  command:
    cmd: >
      openssl pkcs7 -print_certs
      -in /usr/local/share/dhsca_fullpath.p7b
      -inform DER
      -out /usr/local/share/dhsca_fullpath.pem
    creates: /usr/local/share/dhsca_fullpath.pem

- name: Copy server and replica setup scripts
  copy:
    src: "{{ item }}"
    dest: /usr/local/sbin
    mode: 0700
  loop:
    - setup_freeipa_replica.sh
    - setup_freeipa_server.sh
